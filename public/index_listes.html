<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test API Modules</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .tabs { margin-bottom: 1em; }
        .tab-button {
            background: #eee;
            border: 1px solid #ccc;
            border-bottom: none;
            padding: 10px 20px;
            cursor: pointer;
            margin-right: 2px;
            font-weight: bold;
        }
        .tab-button.active { background: #fff; border-bottom: 1px solid #fff; }
        .tab-content { display: none; border: 1px solid #ccc; padding: 1em; background: #fff; }
        .tab-content.active { display: block; }
        table { border-collapse: collapse; width: 100%; margin-top: 1em; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f5f5f5; }
        .status-on { color: orangered; font-weight: bold; }
        .status-off { color: black; font-weight: bold; }
        .action-btn { padding: 4px 8px; margin: 0 2px; }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 5px;
            background: #ddd;
            outline: none;
            border-radius: 5px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
        }

        input[type="range"]::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
    </style>
</head>
<body>
    <h1>Test API Modules</h1>
    <div class="tabs" id="categoryTabs"></div>
    <div id="tabContents"></div>

    <script>
        // Liste des catégories à afficher
        const CATEGORIES = ['blind', 'relay', 'dimmer', 'button', 'temp'];
        let activeCategory = 'relay';

        // Stockage des modules par catégorie
        let modulesByCategory = {};

        // Fonction pour récupérer les modules depuis l'API
        async function fetchModules() {
            try {
                const response = await fetch('/modules');
                if (!response.ok) throw new Error('Erreur lors de la récupération des modules');
                const data = await response.json();
                return Object.values(data);
            } catch (err) {
                alert('Erreur API: ' + err.message);
                return [];
            }
        }

        // Organise les modules par catégorie
        function groupModulesByCategory(modules) {
            const grouped = {};
            CATEGORIES.forEach(cat => grouped[cat] = []);
            modules.forEach(mod => {
                if (Array.isArray(mod.cat)) {
                    mod.cat.forEach(cat => {
                        if (CATEGORIES.includes(cat)) {
                            grouped[cat].push(mod);
                        }
                    });
                }
            });
            return grouped;
        }

        // Génère les onglets de catégories
        function renderTabs(categories) {
            const tabsDiv = document.getElementById('categoryTabs');
            tabsDiv.innerHTML = '';
            categories.forEach((cat, idx) => {
                const btn = document.createElement('button');
                btn.className = 'tab-button' + (idx === 0 ? ' active' : '');
                btn.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                btn.onclick = () => activateTab(cat);
                tabsDiv.appendChild(btn);
            });
        }

        // Génère le contenu de chaque onglet (tableau)
        function renderTabContents(groupedModules) {
            const contentsDiv = document.getElementById('tabContents');
            contentsDiv.innerHTML = '';
            CATEGORIES.forEach((cat, idx) => {
                const div = document.createElement('div');
                div.className = 'tab-content' + (idx === 0 ? ' active' : '');
                div.id = 'tab-' + cat;
                div.appendChild(renderTableForCategory(cat, groupedModules[cat]));
                contentsDiv.appendChild(div);
            });
        }

        // Génère un tableau HTML pour une catégorie
        function renderTableForCategory(category, modules) {
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <th>Nom</th>
                <th>Adresse-Part</th>
                <th>État</th>
                ${(category != 'temp') ? '<th>Action</th>' : ''}
            `;
            thead.appendChild(tr);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            if (modules.length === 0) {
                const trEmpty = document.createElement('tr');
                trEmpty.innerHTML = `<td colspan="${category != 'temp' ? 4 : 3}">Aucun module</td>`;
                tbody.appendChild(trEmpty);
            } else {
                modules.forEach(mod => {
                    const tr = document.createElement('tr');
                    let action
                    switch (category) {
                        case 'relay':
                            action = `<td>${renderRelayActions(mod)}</td>`
                            break;
                        case 'blind':
                            action = `<td>${renderBlindActions(mod)}</td>`
                            break;
                        case 'dimmer':
                            action = `<td>${renderDimmerActions(mod)}</td>`
                            break;
                        default:
                            break;
                    }
                    tr.innerHTML = `
                        <td>${mod.name || mod.id || ''}</td>
                        <td>${mod.address}-${mod.part}</td>
                        <td>${formatStatus(mod, category)}</td>
                        ${action}
                    `;
                    tbody.appendChild(tr);
                });
            }
            table.appendChild(tbody);
            return table;
        }

        // Formate l'état selon la catégorie
        function formatStatus(mod, category) {
            if (!mod.status) return '';
            if (category === 'relay') {
                // Supposons que status.on est l'état du relais
                return (mod.status.current == "on" || mod.status.current == "blink")
                    ? '<span class="status-on">ON</span>'
                    : '<span class="status-off">OFF</span>';
            }
            if (category === 'dimmer') {
                return typeof mod.status.current !== 'undefined'
                    ? mod.status.current + '%'
                    : '';
            }
            if (category === 'blind') {
                return 'Fermé à : ' + mod.status.currentClosedPosition+ '% ('+mod.status.current+')';
            }
            if (category === 'button') {
                return mod.status.pressed
                    ? '<span class="status-on">Appuyé</span>'
                    : '<span class="status-off">Relâché</span>';
            }
            if (category === 'temp') {
                return '<span>'+mod.status.current+'°C</span>';
            }
            return JSON.stringify(mod.status);
        }

        // Active l'onglet sélectionné
        function activateTab(category) {
            activeCategory = category;
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === category);
            });
            document.querySelectorAll('.tab-content').forEach(div => {
                div.classList.toggle('active', div.id === 'tab-' + category);
            });
        }

        // Charge les modules et affiche tout
        async function loadAndRender() {
            await new Promise(resolve => setTimeout(resolve, 100));
            const modules = await fetchModules();
            modulesByCategory = groupModulesByCategory(modules);
            renderTabs(CATEGORIES);
            renderTabContents(modulesByCategory);
            activateTab(activeCategory);
        }

        // GESTION BLIND ----------------------------------------------------------------------------------
        // Génère les boutons d'action pour les volets
        function renderBlindActions(mod) {
            // On suppose que l'API attend /relay/:key/:status (status = 1 ou 0)
            return `
                <button class="action-btn" onclick="setBlindStatus(${mod.address},${mod.part},1)">UP</button>
                <button class="action-btn" onclick="setBlindStatus(${mod.address},${mod.part},-1)">DOWN</button>
                <button class="action-btn" onclick="setBlindStatus(${mod.address},${mod.part},0)">STOP</button>
                <button class="action-btn" onclick="setSubModuleName(${mod.address},${mod.part})">✏️</button>
                <button class="action-btn" onclick="setSubModuleBlindTime(${mod.address},${mod.part})">⏳️</button>
            `;
        }
        // Fonction globale pour changer l'état d'un volet
        window.setBlindStatus = async function(address, part, status) {
            try {
                const url = `/blind/${address}-${part}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: parseInt(status) })
                });
                if (!response.ok) throw new Error('Erreur lors de la commande');
                // Rafraîchir la liste après action
                await loadAndRender();
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        };

        // GESTION RELAY ----------------------------------------------------------------------------------
        // Génère les boutons d'action pour les relais
        function renderRelayActions(mod) {
            // On suppose que l'API attend /relay/:key/:status (status = 1 ou 0)
            return `
                <button class="action-btn" onclick="setRelayStatus(${mod.address},${mod.part},1)">ON</button>
                <button class="action-btn" onclick="setRelayStatus(${mod.address},${mod.part},0)">OFF</button>
                <button class="action-btn" onclick="setSubModuleName(${mod.address},${mod.part})">✏️</button>
            `;
        }
        // Fonction globale pour changer l'état d'un relais
        window.setRelayStatus = async function(address, part, status) {
            try {
                const url = `/relay/${address}-${part}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: parseInt(status) })
                });
                if (!response.ok) throw new Error('Erreur lors de la commande');
                // Rafraîchir la liste après action
                await loadAndRender();
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        };
        // Fonction globale pour changer le d'un relais
        window.setSubModuleName = async function(address, part) {
            name = prompt(`Nouveau nom pour ${address}-${part}?`)
            try {
                const url = `/modules/name/${address}-${part}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: name })
                });
                if (!response.ok) throw new Error('Erreur lors de la commande');
                // Rafraîchir la liste après action
                await loadAndRender();
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        };

        window.setSubModuleBlindTime = async function(address, part) {
            duration = prompt(`Durée fermeture pour ${address}-${part}?`)
            try {
                const url = `/modules/blind/${address}-${part}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ duration: duration })
                });
                if (!response.ok) throw new Error('Erreur lors de la commande');
                // Rafraîchir la liste après action
                await loadAndRender();
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        }

        // GESTION DIMMER ----------------------------------------------------------------------------------
        // Génère les contrôles d'action pour les dimmers
        function renderDimmerActions(mod) {
            const currentValue = mod.status && typeof mod.status.current !== 'undefined' ? mod.status.current : 0;
            return `
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="range" 
                        min="0" 
                        max="100" 
                        value="${currentValue}" 
                        id="dimmer-${mod.address}-${mod.part}"
                        style="width: 100px;"
                        onchange="setDimmerStatus(${mod.address},${mod.part},this.value)">
                    <span id="value-${mod.address}-${mod.part}" style="min-width: 35px;">${currentValue}%</span>
                    <button class="action-btn" onclick="setDimmerStatus(${mod.address},${mod.part},0)">OFF</button>
                    <button class="action-btn" onclick="setSubModuleName(${mod.address},${mod.part})">✏️</button>
                </div>
            `;
        }

        // Fonction globale pour changer l'état d'un dimmer
        window.setDimmerStatus = async function(address, part, status) {
            try {
                console.log(address+"-"+part,"=>", status)
                const url = `/dimmer/${address}-${part}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: parseInt(status) })
                });
                if (!response.ok) throw new Error('Erreur lors de la commande');
                
                // Mettre à jour l'affichage de la valeur en temps réel
                const valueSpan = document.getElementById(`value-${address}-${part}`);
                if (valueSpan) {
                    valueSpan.textContent = status + '%';
                }
                
                // Rafraîchir la liste après action (optionnel, peut être commenté pour de meilleures performances)
                // await loadAndRender();
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        };

        // Initialisation au chargement
        loadAndRender();
    </script>
</body>
</html>
