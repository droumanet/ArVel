<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test API Modules</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .tabs { margin-bottom: 1em; }
        .tab-button {
            background: #eee;
            border: 1px solid #ccc;
            border-bottom: none;
            padding: 10px 20px;
            cursor: pointer;
            margin-right: 2px;
            font-weight: bold;
        }
        .tab-button.active { background: #fff; border-bottom: 1px solid #fff; }
        .tab-content { display: none; border: 1px solid #ccc; padding: 1em; background: #fff; }
        .tab-content.active { display: block; }
        table { border-collapse: collapse; width: 100%; margin-top: 1em; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f5f5f5; }
        .status-on { color: green; font-weight: bold; }
        .status-off { color: red; font-weight: bold; }
        .action-btn { padding: 4px 8px; margin: 0 2px; }
    </style>
</head>
<body>
    <h1>Test API Modules</h1>
    <div class="tabs" id="categoryTabs"></div>
    <div id="tabContents"></div>

    <script>
        // Liste des catégories à afficher
        const CATEGORIES = ['blind', 'relay', 'dimmer', 'button'];
        let activeCategory = 'relay';

        // Stockage des modules par catégorie
        let modulesByCategory = {};

        // Fonction pour récupérer les modules depuis l'API
        async function fetchModules() {
            try {
                const response = await fetch('/modules');
                if (!response.ok) throw new Error('Erreur lors de la récupération des modules');
                const data = await response.json();
                return Object.values(data);
            } catch (err) {
                alert('Erreur API: ' + err.message);
                return [];
            }
        }

        // Organise les modules par catégorie
        function groupModulesByCategory(modules) {
            const grouped = {};
            CATEGORIES.forEach(cat => grouped[cat] = []);
            modules.forEach(mod => {
                if (Array.isArray(mod.cat)) {
                    mod.cat.forEach(cat => {
                        if (CATEGORIES.includes(cat)) {
                            grouped[cat].push(mod);
                        }
                    });
                }
            });
            return grouped;
        }

        // Génère les onglets de catégories
        function renderTabs(categories) {
            const tabsDiv = document.getElementById('categoryTabs');
            tabsDiv.innerHTML = '';
            categories.forEach((cat, idx) => {
                const btn = document.createElement('button');
                btn.className = 'tab-button' + (idx === 0 ? ' active' : '');
                btn.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                btn.onclick = () => activateTab(cat);
                tabsDiv.appendChild(btn);
            });
        }

        // Génère le contenu de chaque onglet (tableau)
        function renderTabContents(groupedModules) {
            const contentsDiv = document.getElementById('tabContents');
            contentsDiv.innerHTML = '';
            CATEGORIES.forEach((cat, idx) => {
                const div = document.createElement('div');
                div.className = 'tab-content' + (idx === 0 ? ' active' : '');
                div.id = 'tab-' + cat;
                div.appendChild(renderTableForCategory(cat, groupedModules[cat]));
                contentsDiv.appendChild(div);
            });
        }

        // Génère un tableau HTML pour une catégorie
        function renderTableForCategory(category, modules) {
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <th>Nom</th>
                <th>Adresse-Part</th>
                <th>État</th>
                ${category === 'relay' ? '<th>Action</th>' : ''}
            `;
            thead.appendChild(tr);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            if (modules.length === 0) {
                const trEmpty = document.createElement('tr');
                trEmpty.innerHTML = `<td colspan="${category === 'relay' ? 4 : 3}">Aucun module</td>`;
                tbody.appendChild(trEmpty);
            } else {
                modules.forEach(mod => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${mod.name || mod.id || ''}</td>
                        <td>${mod.address}-${mod.part}</td>
                        <td>${formatStatus(mod, category)}</td>
                        ${category === 'relay' ? `<td>${renderRelayActions(mod)}</td>` : ''}
                    `;
                    tbody.appendChild(tr);
                });
            }
            table.appendChild(tbody);
            return table;
        }

        // Formate l'état selon la catégorie
        function formatStatus(mod, category) {
            if (!mod.status) return '';
            if (category === 'relay') {
                // Supposons que status.on est l'état du relais
                return mod.status.on
                    ? '<span class="status-on">ON</span>'
                    : '<span class="status-off">OFF</span>';
            }
            if (category === 'dimmer') {
                return typeof mod.status.level !== 'undefined'
                    ? mod.status.level + '%'
                    : '';
            }
            if (category === 'blind') {
                return mod.status.position !== undefined
                    ? 'Position: ' + mod.status.position
                    : '';
            }
            if (category === 'button') {
                return mod.status.pressed
                    ? '<span class="status-on">Appuyé</span>'
                    : '<span class="status-off">Relâché</span>';
            }
            return JSON.stringify(mod.status);
        }

        // Génère les boutons d'action pour les relais
        function renderRelayActions(mod) {
            // On suppose que l'API attend /relay/:addr/:part/:status (status = 1 ou 0)
            return `
                <button class="action-btn" onclick="setRelayStatus(${mod.address},${mod.part},1)">ON</button>
                <button class="action-btn" onclick="setRelayStatus(${mod.address},${mod.part},0)">OFF</button>
            `;
        }

        // Active l'onglet sélectionné
        function activateTab(category) {
            activeCategory = category;
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === category);
            });
            document.querySelectorAll('.tab-content').forEach(div => {
                div.classList.toggle('active', div.id === 'tab-' + category);
            });
        }

        // Fonction globale pour changer l'état d'un relais
        window.setRelayStatus = async function(address, part, status) {
            try {
                const url = `/relay/${address}/${part}/${status}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Erreur lors de la commande');
                // Rafraîchir la liste après action
                await loadAndRender();
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        };

        // Charge les modules et affiche tout
        async function loadAndRender() {
            const modules = await fetchModules();
            modulesByCategory = groupModulesByCategory(modules);
            renderTabs(CATEGORIES);
            renderTabContents(modulesByCategory);
            activateTab(activeCategory);
        }

        // Initialisation au chargement
        loadAndRender();
    </script>
</body>
</html>
